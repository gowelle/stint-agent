name: Publish to npm

on:
    release:
        types: [created]
    workflow_dispatch: # Manual trigger option

jobs:
    # Run CI checks first
    ci:
        uses: ./.github/workflows/ci.yml

    publish:
        needs: ci # Wait for CI to pass
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write # Required for OIDC

        steps:
            - uses: actions/checkout@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  registry-url: "https://registry.npmjs.org"

            - run: npm ci

            - run: npm run build

            # Publish with provenance (automatic with Trusted Publisher)
            - run: npm publish --access public
